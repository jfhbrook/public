#!/usr/bin/env bash

# Copyright 2021 Josh Holbrook
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

KBLOCK_CONFIG="${KBLOCK_CONFIG:-${HOME}/.config/korbenware/kblock.env}"

if [ -f "${KBLOCK_CONFIG}" ]; then
  source "${KBLOCK_CONFIG}"
fi

COWSAY_COWS_DIR="${COWSAY_COWS_DIR:-$(kbconfig get lock cowsay_cows_dir)}"

if [ -z "${COWSAY_COWS_DIR}" ]; then
  if [ -d "/usr/share/cows" ]; then  # arch
    COWSAY_COWS_DIR="/usr/share/cows"
  elif [ -d "/usr/share/cowsay" ]; then  # fedora
    COWSAY_COWS_DIR="/usr/share/cowsay"
  fi
fi

KBLOCK_MODE="$(kbconfig get lock mode)"
KBLOCK_MESSAGE="$(kbconfig get lock message)"

COWSAY_BIN="$(kbconfig get lock cowsay_bin)"
if [ -z "${COWSAY_BIN}" ]; then
  COWSAY_BIN="$(shuf -n 1 -e cowsay cowthink)"
fi
FORTUNE_BIN="$(kbconfig get lock fortune_bin)"
FORTUNE_ARGS="$(kbconfig get lock fortune_args)"
PHYSLOCK_BIN="$(kbconfig get lock physlock_bin)"
PHYSLOCK_ARGS="$(kbconfig get lock physlock_args)"
SWAYLOCK_BIN="$(kbconfig get lock swaylock_bin)"
SWAYLOCK_ARGS="$(kbconfig get lock swaylock_args)"
COWSAY_WIDTH="$(kbconfig get lock cowsay_width)"

SWAYLOCK_DARKBLUE="$(kbconfig get lock darkblue)"
SWAYLOCK_BLUE="$(kbconfig get lock blue)"
SWAYLOCK_LIGHTBLUE="$(kbconfig get lock lightblue)"
SWAYLOCK_LIGHTALT="$(kbconfig get lock lightalt)"
SWAYLOCK_CYAN="$(kbconfig get lock cyan)"
SWAYLOCK_PINK="$(kbconfig get lock pink)"
SWAYLOCK_PURPLE="$(kbconfig get lock purple)"
SWAYLOCK_PURPLEALT="$(kbconfig get lock purplealt)"
SWAYLOCK_RED="$(kbconfig get lock red)"
SWAYLOCK_ORANGE="$(kbconfig get lock orange)"
SWAYLOCK_WHITE="$(kbconfig get lock white)"
SWAYLOCK_YELLOW="$(kbconfig get lock yellow)"
SWAYLOCK_GREEN="$(kbconfig get lock green)"

SWAYLOCK_COLOR="$(kbconfig get lock swaylock_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_INSIDE_COLOR="$(kbconfig get lock swaylock_inside_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_RING_COLOR="$(kbconfig get lock swaylock_ring_color --if-none "${SWAYLOCK_PURPLE}")"
SWAYLOCK_LINE_COLOR="$(kbconfig get lock swaylock_line_color --if-none "${SWAYLOCK_PURPLEALT}")"
SWAYLOCK_SEPARATOR_COLOR="$(kbconfig get lock swaylock_separator_color --if-none "${SWAYLOCK_PURPLEALT}")"
SWAYLOCK_TEXT_COLOR="$(kbconfig get lock swaylock_text_color --if-none "${SWAYLOCK_WHITE}")"
SWAYLOCK_KEY_HL_COLOR="$(kbconfig get lock swaylock_key_hl_color --if-none "${SWAYLOCK_PINK}")"
SWAYLOCK_BS_HL_COLOR="$(kbconfig get lock swaylock_bs_hl_color --if-none "${SWAYLOCK_LIGHTBLUE}")"
SWAYLOCK_LAYOUT_BG_COLOR="$(kbconfig get lock swaylock_layout_bg_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_LAYOUT_BORDER_COLOR="$(kbconfig get lock swaylock_layout_border_color --if-none "${SWAYLOCK_BLUE}")"
SWAYLOCK_LAYOUT_TEXT_COLOR="$(kbconfig get lock swaylock_layout_text_color --if-none "${SWAYLOCK_WHITE}")"
SWAYLOCK_INSIDE_CLEAR_COLOR="$(kbconfig get lock swaylock_inside_clear_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_RING_CLEAR_COLOR="$(kbconfig get lock swaylock_ring_clear_color --if-none "${SWAYLOCK_LIGHTBLUE}")"
SWAYLOCK_LINE_CLEAR_COLOR="$(kbconfig get lock swaylock_line_clear_color --if-none "${SWAYLOCK_PURPLEALT}")"
SWAYLOCK_TEXT_CLEAR_COLOR="$(kbconfig get lock swaylock_text_clear_color --if-none "${SWAYLOCK_WHITE}")"
SWAYLOCK_INSIDE_VER_COLOR="$(kbconfig get lock swaylock_inside_ver_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_RING_VER_COLOR="$(kbconfig get lock swaylock_ring_ver_color --if-none "${SWAYLOCK_LIGHTBLUE}")"
SWAYLOCK_LINE_VER_COLOR="$(kbconfig get lock swaylock_line_ver_color --if-none "${SWAYLOCK_PURPLEALT}")"
SWAYLOCK_TEXT_VER_COLOR="$(kbconfig get lock swaylock_text_ver_color --if-none "${SWAYLOCK_WHITE}")"
SWAYLOCK_INSIDE_WRONG_COLOR="$(kbconfig get lock swaylock_inside_ver_color --if-none "${SWAYLOCK_DARKBLUE}")"
SWAYLOCK_RING_WRONG_COLOR="$(kbconfig get lock swaylock_ring_wrong_color --if-none "${SWAYLOCK_ORANGE}")"
SWAYLOCK_LINE_WRONG_COLOR="$(kbconfig get lock swaylock_line_wrong_color --if-none "${SWAYLOCK_RED}")"
SWAYLOCK_TEXT_WRONG_COLOR="$(kbconfig get lock swaylock_text_wrong_color --if-none "${SWAYLOCK_WHITE}")"
SWAYLOCK_TEXT_CAPS_LOCK_COLOR="$(kbconfig get lock swaylock_text_caps_lock_color --if-none "${SWAYLOCK_PINK}")"


case ${KBLOCK_MODE} in
  physlock)
    COWSAY_FLAG="-$(shuf -n 1 -e b d g p s t w y)"
    COW_FILE="$(find "${COWSAY_COWS_DIR}" -type f -iname '*.cow' | sed 's/\.cow$//' | shuf -n 1)"
    INDENT="            "
    PHYSLOCK_PROMPT="


    $(${FORTUNE_BIN} ${FORTUNE_ARGS} | ${COWSAY_BIN} -w ${COWSAY_WIDTH} -f "${COW_FILE}" | sed "s/^/${INDENT}/g")

    ${INDENT}${KBLOCK_MESSAGE}"

    exec ${PHYSLOCK_BIN} -d -p ${PHYSLOCK_ARGS} "${PHYSLOCK_PROMPT}"
    ;;
  swaylock)
    exec swaylock -f ${SWAYLOCK_ARGS} \
      --color "${SWAYLOCK_COLOR}" \
      --inside-color "${SWAYLOCK_INSIDE_COLOR}" \
      --ring-color "${SWAYLOCK_RING_COLOR}" \
      --line-color "${SWAYLOCK_LINE_COLOR}" \
      --separator-color "${SWAYLOCK_SEPARATOR_COLOR}" \
      --text-color "${SWAYLOCK_TEXT_COLOR}" \
      --key-hl-color "${SWAYLOCK_KEY_HL_COLOR}" \
      --bs-hl-color "${SWAYLOCK_BS_HL_COLOR}" \
      --layout-bg-color "${SWAYLOCK_LAYOUT_BG_COLOR}" \
      --layout-border-color "${SWAYLOCK_LAYOUT_BORDER_COLOR}" \
      --layout-text-color "${SWAYLOCK_LAYOUT_TEXT_COLOR}" \
      --inside-clear-color "${SWAYLOCK_INSIDE_CLEAR_COLOR}" \
      --ring-clear-color "${SWAYLOCK_RING_CLEAR_COLOR}" \
      --line-clear-color "${SWAYLOCK_LINE_CLEAR_COLOR}" \
      --text-clear-color "${SWAYLOCK_TEXT_CLEAR_COLOR}" \
      --inside-ver-color "${SWAYLOCK_INSIDE_VER_COLOR}" \
      --ring-ver-color "${SWAYLOCK_RING_VER_COLOR}" \
      --line-ver-color "${SWAYLOCK_LINE_VER_COLOR}" \
      --text-ver-color "${SWAYLOCK_TEXT_VER_COLOR}" \
      --inside-wrong-color "${SWAYLOCK_INSIDE_WRONG_COLOR}" \
      --ring-wrong-color "${SWAYLOCK_RING_WRONG_COLOR}" \
      --line-wrong-color "${SWAYLOCK_LINE_WRONG_COLOR}" \
      --text-wrong-color "${SWAYLOCK_TEXT_WRONG_COLOR}" \
      --text-caps-lock-color "${SWAYLOCK_TEXT_CAPS_LOCK_COLOR}"
    ;;
  *)
    echo "info: Unknown KBLOCK_MODE ${KBLOCK_MODE}"
    exit 1
  ;;
esac
