#!/usr/bin/env bash

# Copyright 2021 Josh Holbrook
#
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

KBLOCK_CONFIG="${KBLOCK_CONFIG:-${HOME}/.config/korbenware/kblock.env}"

if [ -f "${KBLOCK_CONFIG}" ]; then
  source "${KBLOCK_CONFIG}"
fi

COWSAY_COWS_DIR="${COWSAY_COWS_DIR:-$(kbconfig get lock cowsay_cows_dir)}"

if [ -z "${COWSAY_COWS_DIR}" ]; then
  if [ -d "/usr/share/cows" ]; then  # arch
    COWSAY_COWS_DIR="/usr/share/cows"
  elif [ -d "/usr/share/cowsay" ]; then  # fedora
    COWSAY_COWS_DIR="/usr/share/cowsay"
  fi
fi

KBLOCK_MODE="$(kbconfig get lock mode)"
KBLOCK_MESSAGE="$(kbconfig get lock message)"

COWSAY_BIN="$(kbconfig get lock cowsay_bin)"
if [ -z "${COWSAY_BIN}" ]; then
  COWSAY_BIN="$(shuf -n 1 -e cowsay cowthink)"
fi
FORTUNE_BIN="$(kbconfig get lock fortune_bin)"
FORTUNE_ARGS="$(kbconfig get lock fortune_args)"
PHYSLOCK_BIN="$(kbconfig get lock physlock_bin)"
PHYSLOCK_ARGS="$(kbconfig get lock physlock_args)"
SWAYLOCK_BIN="$(kbconfig get lock swaylock_bin)"
SWAYLOCK_ARGS="$(kbconfig get lock swaylock_args)"

COWSAY_WIDTH="$(kbconfig get lock cowsay_width)"

# Cyberpunk Neon theme
SWAYLOCK_DARKBLUE="$(kbconfig get lock darkblue)"
SWAYLOCK_BLUE="$(kbconfig get lock blue)"
SWAYLOCK_LIGHTBLUE="$(kbconfig get lock lightblue)"
SWAYLOCK_LIGHTALT="$(kbconfig get lock lightalt)"
SWAYLOCK_CYAN="$(kbconfig get lock cyan)"
SWAYLOCK_PINK="$(kbconfig get lock pink)"
SWAYLOCK_PURPLE="$(kbconfig get lock purple)"
SWAYLOCK_PURPLEALT="$(kbconfig get lock purplealt)"
SWAYLOCK_RED="$(kbconfig get lock red)"
SWAYLOCK_ORANGE="$(kbconfig get lock orange)"
SWAYLOCK_WHITE="$(kbconfig get lock white)"
SWAYLOCK_YELLOW="$(kbconfig get lock yellow)"
SWAYLOCK_GREEN="$(kbconfig get lock green)"


case ${KBLOCK_MODE} in
  physlock)
    COWSAY_FLAG="-$(shuf -n 1 -e b d g p s t w y)"
    COW_FILE="$(find "${COWSAY_COWS_DIR}" -type f -iname '*.cow' | sed 's/\.cow$//' | shuf -n 1)"
    INDENT="            "
    PHYSLOCK_PROMPT="


    $(${FORTUNE_BIN} ${FORTUNE_ARGS} | ${COWSAY_BIN} -w ${COWSAY_WIDTH} -f "${COW_FILE}" | sed "s/^/${INDENT}/g")

    ${INDENT}${KBLOCK_MESSAGE}"

    exec ${PHYSLOCK_BIN} -d -p ${PHYSLOCK_ARGS} "${PHYSLOCK_PROMPT}"
    ;;
  swaylock)
    exec swaylock -f ${SWAYLOCK_ARGS} \
      --color "${SWAYLOCK_DARKBLUE}" \
      --inside-color "${SWAYLOCK_DARKBLUE}" \
      --ring-color "${SWAYLOCK_PURPLE}" \
      --line-color "${SWAYLOCK_PURPLEALT}" \
      --separator-color "${SWAYLOCK_PURPLEALT}" \
      --text-color "${SWAYLOCK_WHITE}" \
      --key-hl-color "${SWAYLOCK_PINK}" \
      --bs-hl-color "${SWAYLOCK_LIGHTBLUE}" \
      --layout-bg-color "${SWAYLOCK_DARKBLUE}" \
      --layout-border-color "${SWAYLOCK_BLUE}" \
      --layout-text-color "${SWAYLOCK_WHITE}" \
      --inside-clear-color "${SWAYLOCK_DARKBLUE}" \
      --ring-clear-color "${SWAYLOCK_LIGHTBLUE}" \
      --line-clear-color "${SWAYLOCK_PURPLEALT}" \
      --text-clear-color "${SWAYLOCK_WHITE}" \
      --inside-ver-color "${SWAYLOCK_DARKBLUE}" \
      --ring-ver-color "${SWAYLOCK_LIGHTBLUE}" \
      --line-ver-color "${SWAYLOCK_PURPLEALT}" \
      --text-ver-color "${SWAYLOCK_WHJITE}" \
      --inside-wrong-color "${SWAYLOCK_DARKBLUE}" \
      --ring-wrong-color "${SWAYLOCK_ORANGE}" \
      --line-wrong-color "${SWAYLOCK_RED}" \
      --text-wrong-color "${SWAYLOCK_WHITE}" \
      --text-caps-lock-color "${SWAYLOCK_PINK}"
    ;;
  *)
    echo "info: Unknown KBLOCK_MODE ${KBLOCK_MODE}"
    exit 1
  ;;
esac
